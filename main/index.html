<!DOCTYPE html>
<html lang='zh-TW'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>ESP32-S3 Controller Dashboard</title>
    <style>
        body { background-color: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 20px; }
        h2 { color: #00bfff; margin-bottom: 10px; }
        
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1200px; margin: auto; }
        .card { background: #2d2d2d; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 280px; flex: 1; }
        .card h3 { border-bottom: 2px solid #444; padding-bottom: 10px; margin-top: 0; color: #fff; }
        
        /* åŸºç¤æŒ‡ç¤ºç‡ˆæ¨£å¼ */
        .indicator { display: inline-block; width: 25px; height: 25px; border-radius: 50%; background: #444; margin: 0 5px; vertical-align: middle; transition: 0.2s; border: 2px solid #555; }
        .indicator.off { background: #333; opacity: 0.3; }
        .indicator.on { background: #00ff00; box-shadow: 0 0 10px #00ff00; border-color: #fff; }

        /* è‡ªå®šç¾©é¡è‰²è¨­å®š */
        #A2.on { background: #ffeb3b; box-shadow: 0 0 10px #ffeb3b; border-color: #fff; } /* é»ƒè‰² */
        #A3.on { background: #00bfff; box-shadow: 0 0 10px #00bfff; border-color: #fff; } /* è—è‰² */
        #A4.on { background: #00ff00; box-shadow: 0 0 10px #00ff00; border-color: #fff; } /* ç¶ è‰² */

        .switch-group { display: flex; justify-content: center; align-items: center; gap: 15px; background: #222; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .switch-item { display: flex; flex-direction: column; align-items: center; }
        .switch-label { font-size: 12px; color: #aaa; margin-top: 5px; display: block; }
        .row { display: flex; justify-content: space-between; margin: 10px 0; align-items: center; }
        
        .progress-container { width: 100%; background: #444; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; background: #00bfff; width: 0%; transition: width 0.1s; }
        
        .dpad { display: grid; grid-template-columns: 25px 25px 25px; grid-template-rows: 25px 25px 25px; gap: 4px; justify-content: center; margin-top: 5px; background: #222; padding: 5px; border-radius: 5px; }
        .dpad-cell { width: 100%; height: 100%; background: #444; border-radius: 3px; }
        .dpad-cell.active { background: #ff4444; box-shadow: 0 0 8px #ff4444; }
        .dpad-center.active { background: #00bfff; box-shadow: 0 0 8px #00bfff; } 
        
        input[type='text'] { width: 90%; padding: 8px; border-radius: 5px; border: none; background: #eee; }
        button { padding: 8px 15px; background: #ff9800; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button:hover { background: #e68900; }
        
        /* è£œå›åŸæœ¬éºå¤±çš„ textarea æ¨£å¼ */
        textarea { width: 95%; height: 60px; background: #111; color: #0f0; border: 1px solid #444; border-radius: 5px; font-family: monospace; font-size: 12px; padding: 5px; resize: none; margin-top: 10px;}
    </style>
</head>
<body>
    <h2>ğŸ® ESP32-S3 æ§åˆ¶ä¸­å¿ƒ</h2>
    
    <div class='container'>
        <!-- é›»æºèˆ‡ç‹€æ…‹ (A) -->
        <div class='card'>
            <h3>é›»æºèˆ‡ç‹€æ…‹ (A)</h3>
            <p>A1 æª”ä½ç‹€æ…‹</p>
            <div class='switch-group'>
                <div class='switch-item'><span id='A1_L' class='indicator'></span><span class='switch-label'>å·¦ (10)</span></div>
                <div class='switch-item'><span id='A1_M' class='indicator'></span><span class='switch-label'>ä¸­ (11)</span></div>
                <div class='switch-item'><span id='A1_R' class='indicator'></span><span class='switch-label'>å³ (01)</span></div>
            </div>
            <p>LED è¼¸å‡ºç‹€æ…‹</p>
            <div class='switch-group'>
                <div class='switch-item'><span id='A2' class='indicator'></span><span class='switch-label'>A2 (å·¦-é»ƒ)</span></div>
                <div class='switch-item'><span id='A3' class='indicator'></span><span class='switch-label'>A3 (ä¸­-è—)</span></div>
                <div class='switch-item'><span id='A4' class='indicator'></span><span class='switch-label'>A4 (å³-ç¶ )</span></div>
            </div>
        </div>
        
        <!-- é¸æ“‡ç«¯ (B) -->
        <div class='card'>
            <h3>é¸æ“‡ç«¯ (B)</h3>
            <p>B1 é¸æ“‡ç‹€æ…‹</p>
            <div class='switch-group'>
                <div class='switch-item'><span id='B1_L' class='indicator'></span><span class='switch-label'>å·¦ (10)</span></div>
                <div class='switch-item'><span id='B1_M' class='indicator'></span><span class='switch-label'>ä¸­ (11)</span></div>
                <div class='switch-item'><span id='B1_R' class='indicator'></span><span class='switch-label'>å³ (01)</span></div>
            </div>
            <div class='row'><span>B4 / B5:</span> <div><span id='B4' class='indicator'></span> <span id='B5' class='indicator'></span></div></div>
            <div style='text-align:left; margin-top: 10px;'>B2 Pot: <span id='val_B2'>0</span></div>
            <div class='progress-container'><div id='bar_B2' class='progress-bar'></div></div>
            <div style='text-align:left; margin-top:5px'>B3 Pot: <span id='val_B3'>0</span></div>
            <div class='progress-container'><div id='bar_B3' class='progress-bar'></div></div>
        </div>
        
        <!-- æ–æ¡¿ (C) -->
        <div class='card'>
            <h3>æ–æ¡¿ç‹€æ…‹ (C)</h3>
            <div style='display:flex; justify-content:space-around'>
               <div><small>C1</small>
                   <div class='dpad'>
                       <div class='dpad-cell'></div>             <div id='C1_1' class='dpad-cell'></div> <div class='dpad-cell'></div>
                       <div id='C1_3' class='dpad-cell'></div>   <div id='C1_C' class='dpad-cell dpad-center'></div> <div id='C1_4' class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C1_2' class='dpad-cell'></div> <div class='dpad-cell'></div>
                   </div>
               </div>
               <div><small>C2</small>
                   <div class='dpad'>
                       <div class='dpad-cell'></div>             <div id='C2_1' class='dpad-cell'></div> <div class='dpad-cell'></div>
                       <div id='C2_3' class='dpad-cell'></div>   <div id='C2_C' class='dpad-cell dpad-center'></div> <div id='C2_4' class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C2_2' class='dpad-cell'></div> <div class='dpad-cell'></div>
                   </div>
               </div>
            </div>
            <div style='display:flex; justify-content:space-around; margin-top:10px'>
               <div><small>C3</small>
                   <div class='dpad'>
                       <div class='dpad-cell'></div>             <div id='C3_1' class='dpad-cell'></div> <div class='dpad-cell'></div>
                       <div id='C3_3' class='dpad-cell'></div>   <div id='C3_C' class='dpad-cell dpad-center'></div> <div id='C3_4' class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C3_2' class='dpad-cell'></div> <div class='dpad-cell'></div>
                   </div>
               </div>
               <div><small>C4</small>
                   <div class='dpad'>
                       <div class='dpad-cell'></div>             <div id='C4_1' class='dpad-cell'></div> <div class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C4_C' class='dpad-cell dpad-center'></div> <div class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C4_2' class='dpad-cell'></div> <div class='dpad-cell'></div>
                   </div>
               </div>
            </div>
        </div>
    </div>

    <!-- OTA & Raw Data -->
    <div class='container'>
        <div style="width: 100%; border:1px solid #ccc; padding:10px; border-radius:8px; margin-top:20px; background:#2d2d2d;">
            <h3>ğŸš€ OTA éŸŒé«”æ›´æ–°ä¸­å¿ƒ</h3>
            
            <p>éŸŒé«”ä¾†æºç¶²å€ (.bin)ï¼š</p>
            <input type='text' id='ota_url' value='https://github.com/machido213/Esp32-S3_Controller/releases/latest/download/Esp32-S3_Controller.bin'>
            
            <div style="margin-top:10px;">
                <small>å¿«é€Ÿå¡«å…¥: </small>
                <button onclick="fillGithub()">GitHub (Latest)</button>
                <button onclick="fillLocal()">Local (é–‹ç™¼)</button>
            </div>

            <br>
            <button onclick='startOTA()' style="background-color: #4CAF50;">ç«‹å³é–‹å§‹æ›´æ–°</button>
            <p id='ota_status' style='color:#ccc; margin-top:10px; font-weight:bold;'></p>

            <hr style="border-color: #444; margin: 15px 0;">
            
            <!-- â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šè£œå›é€™å€‹ raw_json å…ƒç´  â˜…â˜…â˜… -->
            <p style="margin:5px;">System Raw Data:</p>
            <textarea id="raw_json" readonly></textarea>
        </div>
    </div>

    <script>
        function updateClass(id, isOn) {
            const el = document.getElementById(id);
            if(!el) return;
            el.classList.remove('on', 'off', 'active');
            if (el.classList.contains('dpad-cell') || el.classList.contains('dpad-center')) {
                if(isOn) el.classList.add('active');
            } else {
                el.classList.add(isOn ? 'on' : 'off');
            }
        }

        function update3PosSwitch(prefix, v1, v2) {
            updateClass(prefix + '_L', (v1 === 1 && v2 === 0));
            updateClass(prefix + '_M', (v1 === 1 && v2 === 1));
            updateClass(prefix + '_R', (v1 === 0 && v2 === 1));
        }

        function updateJoystick(prefix, arr) {
            updateClass(prefix + '_1', arr[0] === 0);
            updateClass(prefix + '_2', arr[1] === 0);
            updateClass(prefix + '_3', arr[2] === 0);
            updateClass(prefix + '_4', arr[3] === 0);
            updateClass(prefix + '_C', (arr[0] && arr[1] && arr[2] && arr[3])); // 1111 = Center
        }

        function updateJoystick2Axis(prefix, arr) {
            updateClass(prefix + '_1', arr[0] === 0);
            updateClass(prefix + '_2', arr[1] === 0);
            updateClass(prefix + '_C', (arr[0] && arr[1])); 
        }

        function fetchStatus() {
            fetch('/status').then(r => r.json()).then(d => {
                // å¦‚æœé€™è¡Œå ±éŒ¯ï¼Œä¸‹é¢çš„ UI éƒ½ä¸æœƒæ›´æ–°ã€‚ç¾åœ¨è£œä¸Šäº† textarea å°±ä¸æœƒéŒ¯äº†ã€‚
                const rawEl = document.getElementById('raw_json');
                if(rawEl) rawEl.value = JSON.stringify(d);

                update3PosSwitch('A1', d.A1_1, d.A1_2);
                updateClass('A2', d.A2 === 1); 
                updateClass('A3', d.A3 === 1); 
                updateClass('A4', d.A4 === 1);
                update3PosSwitch('B1', d.B1_1, d.B1_2);
                updateClass('B4', d.B4 === 0); // å‡è¨­æŒ‰ä¸‹æ˜¯ 0
                updateClass('B5', d.B5 === 0);

                document.getElementById('val_B2').innerText = d.B2_pot;
                document.getElementById('bar_B2').style.width = (d.B2_pot / 40.95) + '%';
                document.getElementById('val_B3').innerText = d.B3_pot;
                document.getElementById('bar_B3').style.width = (d.B3_pot / 40.95) + '%';

                updateJoystick('C1', d.C1);
                updateJoystick('C2', d.C2);
                updateJoystick('C3', d.C3);
                updateJoystick2Axis('C4', d.C4);
            }).catch(e => console.log('Error:', e));
        }

        // æ³¨æ„ï¼šGitHub çš„ OTA é€£çµå¿…é ˆæ˜¯ /download/ ä¸æ˜¯ /tag/
        const GITHUB_URL = "https://github.com/machido213/Esp32-S3_Controller/releases/latest/download/Esp32-S3_Controller.bin";
        const LOCAL_URL  = "http://192.168.2.105:8000/Esp32-S3_Controller.bin";

        function fillGithub() { document.getElementById('ota_url').value = GITHUB_URL; }
        function fillLocal() { document.getElementById('ota_url').value = LOCAL_URL; }

        function startOTA() {
            const url = document.getElementById('ota_url').value;
            if(!url) { alert('è«‹è¼¸å…¥ URL'); return; }
            if(!confirm("ç¢ºå®šè¦æ›´æ–°å—ï¼Ÿ ESP32 å°‡æœƒé‡å•Ÿã€‚")) return;

            document.getElementById('ota_status').innerText = 'â³ æ­£åœ¨æ›´æ–°ä¸­ï¼Œè«‹ç•™æ„ ESP32 æ˜¯å¦é‡å•Ÿ...';
            
            fetch('/ota', {
                method: 'POST',
                body: JSON.stringify({url: url})
            }).then(r => r.text()).then(t => {
                document.getElementById('ota_status').innerText = 'System: ' + t;
            }).catch(e => {
                document.getElementById('ota_status').innerText = 'Error: ' + e;
            });
        }

        setInterval(fetchStatus, 300);
        fetchStatus();
    </script>
</body>
</html>