<!DOCTYPE html>
<html lang='zh-TW'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>ESP32-S3 Controller Dashboard</title>
    <style>
        body { background-color: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 20px; }
        h2 { color: #00bfff; margin-bottom: 10px; }
        
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1200px; margin: auto; }
        .card { background: #2d2d2d; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 280px; flex: 1; }
        .card h3 { border-bottom: 2px solid #444; padding-bottom: 10px; margin-top: 0; color: #fff; }
        
        /* åŸºç¤æŒ‡ç¤ºç‡ˆæ¨£å¼ */
        .indicator { display: inline-block; width: 25px; height: 25px; border-radius: 50%; background: #444; margin: 0 5px; vertical-align: middle; transition: 0.2s; border: 2px solid #555; }
        .indicator.off { background: #333; opacity: 0.3; }

        /* A1 & B1 é è¨­é¡è‰² (ç¶ è‰²) */
        .indicator.on { background: #00ff00; box-shadow: 0 0 10px #00ff00; border-color: #fff; }

        /* â˜…â˜…â˜… è‡ªå®šç¾©é¡è‰²è¨­å®š (A2=é»ƒ, A3=è—, A4=ç¶ ) â˜…â˜…â˜… */
        #A2.on { background: #ffeb3b; box-shadow: 0 0 10px #ffeb3b; border-color: #fff; } /* é»ƒè‰² */
        #A3.on { background: #00bfff; box-shadow: 0 0 10px #00bfff; border-color: #fff; } /* è—è‰² */
        #A4.on { background: #00ff00; box-shadow: 0 0 10px #00ff00; border-color: #fff; } /* ç¶ è‰² */

        /* é–‹é—œç¾¤çµ„å®¹å™¨ (ç°è‰²èƒŒæ™¯) */
        .switch-group { display: flex; justify-content: center; align-items: center; gap: 15px; background: #222; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .switch-item { display: flex; flex-direction: column; align-items: center; }
        .switch-label { font-size: 12px; color: #aaa; margin-top: 5px; display: block; }
        
        .row { display: flex; justify-content: space-between; margin: 10px 0; align-items: center; }
        
        /* é€²åº¦æ¢ */
        .progress-container { width: 100%; background: #444; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; background: #00bfff; width: 0%; transition: width 0.1s; }
        
        /* æ–æ¡¿é¡¯ç¤º (ä¹å®®æ ¼) */
        .dpad { display: grid; grid-template-columns: 25px 25px 25px; grid-template-rows: 25px 25px 25px; gap: 4px; justify-content: center; margin-top: 5px; background: #222; padding: 5px; border-radius: 5px; }
        .dpad-cell { width: 100%; height: 100%; background: #444; border-radius: 3px; }
        .dpad-cell.active { background: #ff4444; box-shadow: 0 0 8px #ff4444; }
        .dpad-center.active { background: #00bfff; box-shadow: 0 0 8px #00bfff; } 
        
        /* OTA & Raw Data */
        input[type='text'] { width: 90%; padding: 8px; border-radius: 5px; border: none; background: #eee; }
        button { padding: 8px 15px; background: #ff9800; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button:hover { background: #e68900; }
        textarea { width: 95%; height: 60px; background: #111; color: #0f0; border: 1px solid #444; border-radius: 5px; font-family: monospace; font-size: 12px; padding: 5px; resize: none; }
        .debug-val { font-size: 12px; color: #aaa; font-family: monospace; }
    </style>
</head>
<body>
    <h2>ğŸ® ESP32-S3 æ§åˆ¶ä¸­å¿ƒ</h2>
    
    <div class='container'>
        <!-- é›»æºèˆ‡ç‹€æ…‹ (A) -->
        <div class='card'>
            <h3>é›»æºèˆ‡ç‹€æ…‹ (A)</h3>
            
            <p>A1 æª”ä½ç‹€æ…‹</p>
            <div class='switch-group'>
                <div class='switch-item'><span id='A1_L' class='indicator'></span><span class='switch-label'>å·¦ (10)</span></div>
                <div class='switch-item'><span id='A1_M' class='indicator'></span><span class='switch-label'>ä¸­ (11)</span></div>
                <div class='switch-item'><span id='A1_R' class='indicator'></span><span class='switch-label'>å³ (01)</span></div>
            </div>

            <p>LED è¼¸å‡ºç‹€æ…‹</p>
            <!-- â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šå°‡ A2/A3/A4 æ”¹ç‚ºæ°´å¹³æ’åˆ—ï¼Œä¸¦åŠ ä¸Šç°è‰²èƒŒæ™¯ â˜…â˜…â˜… -->
            <div class='switch-group'>
                <div class='switch-item'>
                    <span id='A2' class='indicator'></span>
                    <span class='switch-label'>A2 (å·¦-é»ƒ)</span>
                </div>
                <div class='switch-item'>
                    <span id='A3' class='indicator'></span>
                    <span class='switch-label'>A3 (ä¸­-è—)</span>
                </div>
                <div class='switch-item'>
                    <span id='A4' class='indicator'></span>
                    <span class='switch-label'>A4 (å³-ç¶ )</span>
                </div>
            </div>
        </div>
        
        <!-- é¸æ“‡ç«¯ (B) -->
        <div class='card'>
            <h3>é¸æ“‡ç«¯ (B)</h3>
            
            <p>B1 é¸æ“‡ç‹€æ…‹</p>
            <div class='switch-group'>
                <div class='switch-item'><span id='B1_L' class='indicator'></span><span class='switch-label'>å·¦ (10)</span></div>
                <div class='switch-item'><span id='B1_M' class='indicator'></span><span class='switch-label'>ä¸­ (11)</span></div>
                <div class='switch-item'><span id='B1_R' class='indicator'></span><span class='switch-label'>å³ (01)</span></div>
            </div>

            <div class='row'><span>B4 / B5:</span> <div><span id='B4' class='indicator'></span> <span id='B5' class='indicator'></span></div></div>
            
            <div style='text-align:left; margin-top: 10px;'>B2 Pot: <span id='val_B2'>0</span></div>
            <div class='progress-container'><div id='bar_B2' class='progress-bar'></div></div>
            
            <div style='text-align:left; margin-top:5px'>B3 Pot: <span id='val_B3'>0</span></div>
            <div class='progress-container'><div id='bar_B3' class='progress-bar'></div></div>
        </div>
        
        <!-- æ–æ¡¿ (C) -->
        <div class='card'>
            <h3>æ–æ¡¿ç‹€æ…‹ (C)</h3>
            <div style='display:flex; justify-content:space-around'>
               <div><small>C1</small>
                   <div class='dpad'>
                       <div class='dpad-cell'></div>             <div id='C1_1' class='dpad-cell'></div> <div class='dpad-cell'></div>
                       <div id='C1_3' class='dpad-cell'></div>   <div id='C1_C' class='dpad-cell dpad-center'></div> <div id='C1_4' class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C1_2' class='dpad-cell'></div> <div class='dpad-cell'></div>
                   </div>
               </div>
               <div><small>C2</small>
                   <div class='dpad'>
                       <div class='dpad-cell'></div>             <div id='C2_1' class='dpad-cell'></div> <div class='dpad-cell'></div>
                       <div id='C2_3' class='dpad-cell'></div>   <div id='C2_C' class='dpad-cell dpad-center'></div> <div id='C2_4' class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C2_2' class='dpad-cell'></div> <div class='dpad-cell'></div>
                   </div>
               </div>
            </div>
            <div style='display:flex; justify-content:space-around; margin-top:10px'>
               <div><small>C3</small>
                   <div class='dpad'>
                       <div class='dpad-cell'></div>             <div id='C3_1' class='dpad-cell'></div> <div class='dpad-cell'></div>
                       <div id='C3_3' class='dpad-cell'></div>   <div id='C3_C' class='dpad-cell dpad-center'></div> <div id='C3_4' class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C3_2' class='dpad-cell'></div> <div class='dpad-cell'></div>
                   </div>
               </div>
               <div><small>C4</small>
                   <div class='dpad'>
                       <div class='dpad-cell'></div>             <div id='C4_1' class='dpad-cell'></div> <div class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C4_C' class='dpad-cell dpad-center'></div> <div class='dpad-cell'></div>
                       <div class='dpad-cell'></div>             <div id='C4_2' class='dpad-cell'></div> <div class='dpad-cell'></div>
                   </div>
               </div>
            </div>
        </div>
    </div>

    <!-- OTA & Raw Data -->
    <div class='container'>
        <div class='card'>
            <h3>ğŸš€ OTA éŸŒé«”æ›´æ–°</h3>
            <input type='text' id='ota_url' placeholder='http://your-server/firmware.bin' value='http://192.168.2.105:8000/Esp32-S3_Controller.bin'>
            <button onclick='startOTA()'>é–‹å§‹æ›´æ–°</button>
            <p id='ota_status' style='color:#aaa; margin-top:5px'></p>
        </div>
        <div class='card'>
            <h3>ğŸ” Raw Status Output</h3>
            <textarea id='raw_json' readonly></textarea>
        </div>
    </div>

    <script>
        // é€šç”¨ï¼šæ›´æ–°ç‡ˆè™Ÿ class
        function updateClass(id, isOn) {
            const el = document.getElementById(id);
            if(!el) return;
            el.classList.remove('on', 'off', 'active');
            
            if (el.classList.contains('dpad-cell') || el.classList.contains('dpad-center')) {
                if(isOn) el.classList.add('active');
            } else {
                el.classList.add(isOn ? 'on' : 'off');
            }
        }

        function update3PosSwitch(prefix, v1, v2) {
            const isMid   = (v1 === 1 && v2 === 1);
            const isLeft  = (v1 === 1 && v2 === 0);
            const isRight = (v1 === 0 && v2 === 1);
            updateClass(prefix + '_L', isLeft);
            updateClass(prefix + '_M', isMid);
            updateClass(prefix + '_R', isRight);
        }

        function updateJoystick(prefix, arr) {
            const up    = (arr[0] === 0);
            const down  = (arr[1] === 0);
            const left  = (arr[2] === 0);
            const right = (arr[3] === 0);
            const isCenter = (!up && !down && !left && !right);

            updateClass(prefix + '_1', up);
            updateClass(prefix + '_2', down);
            updateClass(prefix + '_3', left);
            updateClass(prefix + '_4', right);
            updateClass(prefix + '_C', isCenter);
        }

        function updateJoystick2Axis(prefix, arr) {
            const up   = (arr[0] === 0);
            const down = (arr[1] === 0);
            const isCenter = (!up && !down);
            updateClass(prefix + '_1', up);
            updateClass(prefix + '_2', down);
            updateClass(prefix + '_C', isCenter);
        }

        function fetchStatus() {
            fetch('/status').then(r => r.json()).then(d => {
                document.getElementById('raw_json').value = JSON.stringify(d);

                // A1 ä¸‰æª”ä½
                update3PosSwitch('A1', d.A1_1, d.A1_2);
                
                // LED è¼¸å‡º (A2, A3, A4)
                updateClass('A2', d.A2 === 1); 
                updateClass('A3', d.A3 === 1); 
                updateClass('A4', d.A4 === 1);

                // B1 ä¸‰æª”ä½
                update3PosSwitch('B1', d.B1_1, d.B1_2);

                // B4/B5 é–‹é—œ
                updateClass('B4', d.B4 === 0); 
                updateClass('B5', d.B5 === 0);

                // é›»ä½å™¨
                document.getElementById('val_B2').innerText = d.B2_pot;
                document.getElementById('bar_B2').style.width = (d.B2_pot / 40.95) + '%';
                document.getElementById('val_B3').innerText = d.B3_pot;
                document.getElementById('bar_B3').style.width = (d.B3_pot / 40.95) + '%';

                // æ–æ¡¿
                updateJoystick('C1', d.C1);
                updateJoystick('C2', d.C2);
                updateJoystick('C3', d.C3);
                updateJoystick2Axis('C4', d.C4);

            }).catch(e => console.log(e));
        }

        function startOTA() {
            const url = document.getElementById('ota_url').value;
            if(!url) { alert('è«‹è¼¸å…¥ URL'); return; }
            if(!confirm('ç¢ºå®šè¦å¾ ' + url + ' æ›´æ–°éŸŒé«”å—ï¼Ÿ')) return;
            document.getElementById('ota_status').innerText = 'æ›´æ–°è«‹æ±‚å·²ç™¼é€...';
            fetch('/ota', {
                method: 'POST',
                body: JSON.stringify({url: url})
            }).then(r => r.text()).then(t => {
                document.getElementById('ota_status').innerText = 'ä¼ºæœå™¨å›æ‡‰: ' + t;
            }).catch(e => {
                document.getElementById('ota_status').innerText = 'éŒ¯èª¤: ' + e;
            });
        }

        setInterval(fetchStatus, 300);
        fetchStatus();
    </script>
</body>
</html>